name: Deploy to Homelab

on:
  push:
    branches: [main]

jobs:
  deploy:
    name: Trigger Homelab Deployment
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Trigger homelab webhook
        env:
          WEBHOOK_SECRET: ${{ secrets.WEBHOOK_SECRET }}
        run: |
          # Generate HMAC signature for webhook authentication
          payload='{"ref":"refs/heads/main","repository":{"full_name":"${{ github.repository }}"},"pusher":{"name":"${{ github.actor }}"}}'
          signature=$(echo -n "$payload" | openssl dgst -sha256 -hmac "$WEBHOOK_SECRET" | sed 's/^.* //')

          # Trigger webhook (update URL when homelab is ready)
          # For now, this will fail - update after Phase 4 of deployment guide
          echo "Webhook payload signature: sha256=$signature"
          echo "Ready to deploy to homelab at https://meals.bordon.family:9000/hooks/deploy-mealframe"

          # Uncomment after homelab webhook is configured:
          # curl -X POST https://meals.bordon.family:9000/hooks/deploy-mealframe \
          #   -H "Content-Type: application/json" \
          #   -H "X-Hub-Signature-256: sha256=$signature" \
          #   -d "$payload" \
          #   --max-time 10 || echo "Webhook trigger sent (may timeout, deployment continues in background)"

      - name: Deployment status
        run: |
          echo "âœ… Code pushed to main branch"
          echo "ðŸ“¦ Homelab webhook will pull latest code and restart containers"
          echo "ðŸ”— App will be available at: https://meals.bordon.family"
